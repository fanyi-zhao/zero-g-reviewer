# ðŸ” Code Review

## Summary

**Recommendation:** âš ï¸ **Request Changes**

This MR introduces a new authentication flow for the API. While the overall approach is sound, there are several security-related issues that should be addressed before merging.

**High-level Risks:**
- Potential credential exposure in logs
- Missing rate limiting on authentication endpoint
- Token expiration not properly validated

**Files Reviewed:**
- `src/auth/login.py`
- `src/auth/tokens.py`
- `src/api/middleware.py`
- `tests/test_auth.py`

## Key Findings

### Blocker

- ðŸ”´ **Credentials logged in plain text** in `src/auth/login.py` (L45-47)
  - *Confidence: high*
  The password parameter is being logged directly, which could expose user credentials in log files.

  ```suggestion
  logger.info(f"Login attempt for user: {username}")
  # Password should never be logged
  ```

### Major

- ðŸŸ  **Missing rate limiting on login endpoint** in `src/api/middleware.py` (L23)
  - *Confidence: high*
  The login endpoint has no rate limiting, making it vulnerable to brute force attacks. Consider implementing exponential backoff or account lockout.

- ðŸŸ  **Token expiration check bypassed** in `src/auth/tokens.py` (L78-82)
  - *Confidence: medium*
  The `is_expired` check can return `False` when the expiration timestamp is `None`, which could allow expired tokens to be used.

  ```suggestion
  def is_expired(self) -> bool:
      if self.expiration is None:
          return True  # Tokens without expiration should be treated as expired
      return datetime.now(UTC) > self.expiration
  ```

### Minor

- ðŸŸ¡ **Error message reveals too much information** in `src/auth/login.py` (L67)
  - *Confidence: medium*
  The error message "User not found" vs "Invalid password" allows attackers to enumerate valid usernames. Consider using a generic message.

  ```suggestion
  raise AuthenticationError("Invalid username or password")
  ```

- ðŸŸ¡ **Missing type hints** in `src/auth/tokens.py` (L12-15)
  Function `create_token` is missing return type annotation.


### Nit

- ðŸ”µ **Inconsistent naming convention** in `src/auth/login.py` (L10)
  Variable `authResult` uses camelCase instead of the project's snake_case convention.

  ```suggestion
  auth_result = authenticate_user(username, password)
  ```

- ðŸ”µ **Unused import** in `src/api/middleware.py` (L3)
  The `typing.Optional` import is not used in this file.

## Tests / Verification

```bash
# Run authentication tests
pytest tests/test_auth.py -v

# Run security-focused tests
pytest tests/test_auth.py -k "security or rate_limit" -v

# Manual verification of rate limiting
for i in {1..10}; do curl -X POST http://localhost:8000/api/login -d '{"username":"test","password":"wrong"}'; done
```

## Pre-Merge Checklist

- [ ] All tests pass
- [ ] Code has been self-reviewed
- [ ] Changes have been tested locally
- [ ] Documentation updated if needed
- [ ] No secrets or sensitive data exposed
- [ ] Rate limiting implemented on login endpoint
- [ ] Logging reviewed for credential exposure
- [ ] Token expiration logic fixed

---
*Generated by Claude CR Agent*
